<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>곡 추가 마법사</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="max-w-5xl mx-auto p-6">

    <nav class="flex justify-between items-center mb-8">
        <a href="index.html" class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 transition font-bold">
            <i data-lucide="arrow-left"></i> 메뉴로 돌아가기
        </a>
        <h1 class="text-xl font-bold text-indigo-700 flex items-center gap-2">
            <i data-lucide="plus-circle"></i> 곡 추가 마법사
        </h1>
    </nav>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-sm border space-y-4">
            <h2 class="font-bold text-lg border-b pb-2">1. 신규 곡 정보</h2>
            <input type="text" id="genTitle" class="w-full p-2 border rounded" placeholder="곡 제목">
            <input type="text" id="genArtist" class="w-full p-2 border rounded" placeholder="가수">
            <input type="text" id="genLink" class="w-full p-2 border rounded" placeholder="유튜브 링크">
            
            <div class="grid grid-cols-1 gap-2">
                <input type="text" id="genTags" class="w-full p-2 border rounded bg-blue-50 text-sm" placeholder="해시태그 (쉼표로 구분: #우울, #팝)">
                <input type="text" id="genComment" class="w-full p-2 border rounded bg-blue-50 text-sm" placeholder="코멘트 (한마디)">
            </div>

            <input type="text" id="genSource" class="w-full p-2 border rounded bg-purple-50" placeholder="번역 출처 (선택)">
            
            <div class="bg-slate-50 p-2 rounded border">
                <div class="flex justify-between mb-1">
                    <label class="text-xs font-bold text-slate-600">가사 정리 옵션</label>
                    <select id="genLineOption" class="text-xs border rounded">
                        <option value="3" selected>3줄 띄기 (추천)</option>
                        <option value="4">과한 엔터 정리</option>
                        <option value="5">모든 빈 줄 제거</option>
                        <option value="0">그대로 유지</option>
                    </select>
                </div>
                <textarea id="genLyrics" rows="6" class="w-full p-2 border rounded resize-none" placeholder="가사 붙여넣기"></textarea>
            </div>
        </div>

        <div class="space-y-4 flex flex-col h-full">
            <div class="bg-white p-6 rounded-lg shadow-sm border flex-1 flex flex-col">
                <h2 class="font-bold text-lg border-b pb-2 mb-2">2. 기존 data.js (ID 계산용)</h2>
                <textarea id="genOldData" rows="4" class="w-full p-2 border rounded bg-slate-50 mb-4" placeholder="기존 data.js 전체를 붙여넣으면 ID를 자동 계산합니다. (비워두면 1번부터 시작)"></textarea>
                
                <button onclick="runGenerator()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded shadow transition">
                    ✨ 코드 생성하기
                </button>

                <h2 class="font-bold text-lg border-b pb-2 mt-6 mb-2">3. 결과 코드</h2>
                <textarea id="genResult" rows="8" class="w-full p-2 border rounded bg-slate-800 text-green-400 flex-1" readonly></textarea>
                <button onclick="copyToClipboard()" class="mt-2 w-full bg-gray-200 hover:bg-gray-300 py-2 rounded text-sm font-bold">복사하기</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        function runGenerator() {
            try {
                const oldCode = document.getElementById('genOldData').value.trim();
                const title = document.getElementById('genTitle').value.trim();
                const artist = document.getElementById('genArtist').value.trim();
                const link = document.getElementById('genLink').value.trim();
                const source = document.getElementById('genSource').value.trim();
                const comment = document.getElementById('genComment').value.trim();
                let tagsStr = document.getElementById('genTags').value.trim();
                let lyrics = document.getElementById('genLyrics').value;
                const option = parseInt(document.getElementById('genLineOption').value);

                if(!title || !link) return alert("제목과 링크는 필수입니다.");

                // ID 계산
                let nextId = 1;
                if (oldCode && oldCode.includes('playlistData')) {
                    const matches = oldCode.match(/id:\s*(\d+)/g);
                    if (matches) nextId = Math.max(...matches.map(s => parseInt(s.replace(/id:\s*/, '')))) + 1;
                }

                // 가사 정리
                lyrics = formatLyrics(lyrics, option, source);

                // 태그 배열 변환
                let hashtags = [];
                if (tagsStr) {
                    hashtags = tagsStr.split(',').map(t => {
                        t = t.trim();
                        return t.startsWith('#') ? t : '#' + t;
                    }).filter(t => t !== "#");
                }

                // 결과 조립
                const newObj = `    {
        id: ${nextId},
        title: "${title}",
        artist: "${artist}",
        link: "${link}",
        hashtags: ${JSON.stringify(hashtags)},
        comment: "${comment.replace(/"/g, '\\"')}",
        lyrics: \`${lyrics}\`
    }`;

                let result = "";
                if (!oldCode || oldCode === "") {
                    result = `export const playlistData = [\n${newObj}\n];`;
                } else {
                    const idx = oldCode.lastIndexOf(']');
                    if(idx === -1) return alert("기존 코드에 닫는 대괄호 ']'가 없습니다.");
                    const before = oldCode.substring(0, idx).trimEnd();
                    const comma = before.endsWith(',') ? '' : ',';
                    result = before + comma + "\n" + newObj + "\n" + oldCode.substring(idx);
                }
                document.getElementById('genResult').value = result;

            } catch (e) { alert("오류: " + e.message); }
        }

        function formatLyrics(text, option, source) {
            let result = text;
            if (option === 3) { 
                const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
                let fmt = "";
                for(let i=0; i<lines.length; i++) {
                    fmt += lines[i] + "\n";
                    if ((i+1) % 3 === 0 && i !== lines.length-1) fmt += "\n";
                }
                result = fmt.trim();
            } else if (option === 4) { 
                result = text.split('\n').map(l => l.trim()).join('\n').replace(/\n{3,}/g, '\n\n').trim();
            } else if (option === 5) { 
                result = text.split('\n').map(l => l.trim()).join('\n').replace(/\n{2,}/g, '\n').trim();
            }

            if (source) {
                if (result.length > 0) result += `\n\n( 출처 : ${source} )`;
                else result = `( 출처 : ${source} )`;
            }
            return result.replace(/`/g, "\\`");
        }

        function copyToClipboard() {
            const el = document.getElementById('genResult');
            el.select();
            document.execCommand('copy');
            alert("복사되었습니다!");
        }
    </script>
</body>
</html>
