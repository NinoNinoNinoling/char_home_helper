<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© í¸ì§‘ê¸° (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-100">

    <nav class="bg-white border-b px-6 py-3 flex justify-between items-center z-10 shrink-0 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-slate-500 hover:text-indigo-600 transition">
                <i data-lucide="arrow-left"></i>
            </a>
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="list-music" class="text-green-600"></i> í†µí•© ë°ì´í„° í¸ì§‘ê¸°
            </h1>
        </div>
        <div class="flex gap-2">
            <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold shadow flex items-center gap-2 transition transform hover:scale-105 border-2 border-green-500">
                <i data-lucide="save" size="18"></i> ìµœì¢… ì½”ë“œ ìƒì„± (ì €ì¥)
            </button>
        </div>
    </nav>

    <div class="bg-white border-b p-4 shrink-0 shadow-sm z-10">
        <label class="block text-xs font-bold text-slate-500 mb-1">ğŸ“‚ data.js ì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <div class="flex gap-2 relative">
            <textarea id="editorInput" rows="1" class="flex-1 p-2 border rounded text-xs bg-slate-50 resize-none h-10 leading-tight focus:ring-2 focus:ring-indigo-500" placeholder="export const playlistData = [...] ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
            <button onclick="loadData()" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold shrink-0">
                ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
            <div id="inputBlocker" class="absolute inset-0 bg-gray-100/80 flex items-center justify-center text-xs font-bold text-gray-500 hidden cursor-not-allowed">
                ì´ë¯¸ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ìš°ì¸¡ ìƒë‹¨ 'ìµœì¢… ì½”ë“œ ìƒì„±'ì„ ëˆ„ë¥´ì„¸ìš”.
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-hidden grid grid-cols-12">
        <div class="col-span-3 bg-white border-r flex flex-col overflow-hidden">
            <div class="p-3 bg-slate-50 border-b flex justify-between items-center">
                <span class="font-bold text-sm text-slate-700">ê³¡ ëª©ë¡ (<span id="songCount">0</span>)</span>
                <button onclick="addNewSong()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">+ ì¶”ê°€</button>
            </div>
            <div id="songList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-slate-100">
                <div class="text-center text-gray-400 text-xs mt-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.</div>
            </div>
        </div>

        <div class="col-span-9 bg-slate-50 flex flex-col overflow-y-auto p-6 scroll-smooth" id="rightPanel">
            <div id="editForm" class="max-w-3xl mx-auto w-full bg-white rounded shadow p-6 hidden">
                <h2 class="text-lg font-bold border-b pb-2 mb-4 flex justify-between">
                    <span>ğŸ“ ìƒì„¸ ì •ë³´ ìˆ˜ì •</span>
                    <span id="currentId" class="text-xs bg-slate-200 px-2 py-1 rounded text-slate-600">ID: -</span>
                </h2>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500">ê³¡ ì œëª©</label>
                            <input type="text" id="editTitle" class="w-full p-2 border rounded focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500">ê°€ìˆ˜</label>
                            <input type="text" id="editArtist" class="w-full p-2 border rounded focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500">ìœ íŠœë¸Œ ë§í¬</label>
                        <input type="text" id="editLink" class="w-full p-2 border rounded focus:border-indigo-500">
                    </div>

                    <div class="grid grid-cols-1 gap-3 p-4 bg-indigo-50 rounded border border-indigo-100">
                        <div>
                            <label class="block text-xs font-bold text-indigo-800 mb-1">ğŸ·ï¸ í•´ì‹œíƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                            <input type="text" id="editTags" class="w-full p-2 border border-indigo-200 rounded text-sm bg-white" placeholder="ì˜ˆ: #ì‹ ë‚¨, #ìš°ìš¸, #íŒ">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-indigo-800 mb-1">ğŸ’¬ ìºë¦­í„° ì½”ë©˜íŠ¸</label>
                            <input type="text" id="editComment" class="w-full p-2 border border-indigo-200 rounded text-sm bg-white" placeholder="ì´ ë…¸ë˜ì— ëŒ€í•œ ìºë¦­í„°ì˜ í•œë§ˆë””...">
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-slate-700">ê°€ì‚¬ í¸ì§‘</label>
                            <div class="flex gap-2">
                                <select id="formatOption" class="text-xs border rounded p-1">
                                    <option value="3">3ì¤„ ë„ê¸°</option>
                                    <option value="4">ê³¼í•œ ì—”í„° ì •ë¦¬</option>
                                    <option value="5">ëª¨ë“  ë¹ˆ ì¤„ ì œê±°</option>
                                </select>
                                <button onclick="applyFormat()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded">ì •ë¦¬ ì ìš©</button>
                            </div>
                        </div>
                        <textarea id="editLyrics" rows="10" class="w-full p-2 border rounded resize-none text-sm"></textarea>
                    </div>

                    <div class="bg-purple-50 p-3 rounded border border-purple-100">
                        <label class="block text-xs font-bold text-purple-700 mb-1">ì¶œì²˜ (ìë™ ë¶„ë¦¬ë¨)</label>
                        <div class="flex gap-2">
                            <input type="text" id="editSource" class="w-full p-2 border border-purple-200 rounded text-sm bg-white" placeholder="http://...">
                            <div class="text-xs text-purple-400 flex items-center shrink-0">* ìë™ ì¶”ê°€ë¨</div>
                        </div>
                    </div>

                    <div class="pt-4 border-t flex justify-between">
                        <button onclick="deleteSong()" class="text-red-500 text-sm hover:underline">ğŸ—‘ï¸ ì‚­ì œ</button>
                        <button onclick="saveSong()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded font-bold shadow">
                            ì ìš© (ì„ì‹œ ì €ì¥)
                        </button>
                    </div>
                </div>
            </div>

            <div id="exportArea" class="hidden mt-8 mb-20 bg-slate-800 p-6 rounded-xl shadow-2xl max-w-4xl mx-auto w-full border-2 border-green-500">
                <div class="flex justify-between text-white mb-3 text-sm items-center">
                    <span class="text-green-400 font-bold text-lg">âœ… ìµœì¢… ì½”ë“œ ìƒì„± ì™„ë£Œ!</span>
                    <button onclick="copyExport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold transition">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
                </div>
                <textarea id="exportResult" rows="12" class="w-full p-3 bg-slate-900 text-green-300 font-mono text-xs rounded border border-slate-700 focus:outline-none focus:ring-2 focus:ring-green-600" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let loadedSongs = [];
        let currentIndex = -1;

        function loadData() {
            const raw = document.getElementById('editorInput').value.trim();
            if (!raw) return alert("ì½”ë“œë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.");
            try {
                let cleanJson = raw.replace(/export\s+const\s+playlistData\s*=\s*/, '').trim();
                if(cleanJson.endsWith(';')) cleanJson = cleanJson.slice(0, -1);
                const func = new Function("return " + cleanJson);
                loadedSongs = func();
                renderList();
                document.getElementById('inputBlocker').classList.remove('hidden');
                document.getElementById('editorInput').disabled = true;
                alert(`${loadedSongs.length}ê³¡ ë¡œë“œ ì™„ë£Œ! ëª©ë¡ì—ì„œ ê³¡ì„ ì„ íƒí•˜ì„¸ìš”.`);
            } catch (e) { alert("ë¡œë“œ ì‹¤íŒ¨: " + e.message); }
        }

        function renderList() {
            const list = document.getElementById('songList');
            document.getElementById('songCount').innerText = loadedSongs.length;
            list.innerHTML = '';
            loadedSongs.forEach((song, idx) => {
                const div = document.createElement('div');
                div.className = "p-2 bg-white rounded border cursor-pointer hover:bg-indigo-50 transition text-sm mb-1 flex justify-between items-center";
                div.innerHTML = `<span class="truncate font-medium">${song.id}. ${song.title}</span>`;
                div.onclick = () => openForm(idx);
                list.appendChild(div);
            });
        }

        function openForm(idx) {
            currentIndex = idx;
            const s = loadedSongs[idx];
            document.getElementById('editForm').classList.remove('hidden');
            document.getElementById('currentId').innerText = `ID: ${s.id}`;
            
            document.getElementById('editTitle').value = s.title;
            document.getElementById('editArtist').value = s.artist || "";
            document.getElementById('editLink').value = s.link;
            document.getElementById('editTags').value = (s.hashtags || []).join(', ');
            document.getElementById('editComment').value = s.comment || ""; // ë°ì´í„° ë¡œë“œ

            let fullLyrics = s.lyrics || "";
            let sourceUrl = "";
            const sourceRegex = /\(\s*ì¶œì²˜\s*:\s*(https?:\/\/[^)\s]+)\s*\)$/i;
            const match = fullLyrics.trim().match(sourceRegex);
            if (match) {
                sourceUrl = match[1];
                fullLyrics = fullLyrics.replace(match[0], "").trim();
            }
            document.getElementById('editLyrics').value = fullLyrics;
            document.getElementById('editSource').value = sourceUrl;
            document.getElementById('exportArea').classList.add('hidden');
        }

        function addNewSong() {
            let maxId = loadedSongs.length > 0 ? Math.max(...loadedSongs.map(s => s.id)) : 0;
            loadedSongs.push({ id: maxId + 1, title: "ìƒˆ ë…¸ë˜", artist: "", link: "", lyrics: "", hashtags: [], comment: "" });
            renderList();
            openForm(loadedSongs.length - 1);
        }

        function applyFormat() {
            const opt = parseInt(document.getElementById('formatOption').value);
            let txt = document.getElementById('editLyrics').value;
            if (opt === 3) {
                const lines = txt.split('\n').map(l => l.trim()).filter(l => l !== "");
                let fmt = "";
                for(let i=0; i<lines.length; i++) {
                    fmt += lines[i] + "\n";
                    if ((i+1) % 3 === 0 && i !== lines.length-1) fmt += "\n";
                }
                txt = fmt.trim();
            } else if (opt === 4) {
                txt = txt.split('\n').map(l => l.trim()).join('\n').replace(/\n{3,}/g, '\n\n').trim();
            } else if (opt === 5) {
                txt = txt.split('\n').map(l => l.trim()).join('\n').replace(/\n{2,}/g, '\n').trim();
            }
            document.getElementById('editLyrics').value = txt;
        }

        // [ì¤‘ìš”] ì €ì¥ ë¡œì§ ê°•í™”
        function saveSong(isSilent = false) {
            if(currentIndex === -1) return;
            
            try {
                const s = loadedSongs[currentIndex];
                
                // 1. ê¸°ë³¸ ì •ë³´ ì €ì¥
                s.title = document.getElementById('editTitle').value || "";
                s.artist = document.getElementById('editArtist').value || "";
                s.link = document.getElementById('editLink').value || "";
                
                // 2. ì½”ë©˜íŠ¸ ì €ì¥ (ê°€ì¥ ë¨¼ì € ìˆ˜í–‰)
                const commentVal = document.getElementById('editComment').value;
                s.comment = commentVal ? commentVal.trim() : "";

                // 3. í•´ì‹œíƒœê·¸ ì €ì¥ (ì—ëŸ¬ ë°©ì§€ìš© try-catch)
                try {
                    let tagsStr = document.getElementById('editTags').value;
                    s.hashtags = tagsStr.split(',').map(t => {
                        t = t.trim();
                        if(!t) return null;
                        return t.startsWith('#') ? t : '#' + t;
                    }).filter(t => t);
                } catch(e) {
                    console.error("Tag parse error", e);
                    s.hashtags = [];
                }

                // 4. ê°€ì‚¬ & ì¶œì²˜
                let lyricsBody = document.getElementById('editLyrics').value || "";
                lyricsBody = lyricsBody.trim();
                const sourceUrl = document.getElementById('editSource').value.trim();

                if(sourceUrl) {
                    if(lyricsBody) lyricsBody += `\n\n( ì¶œì²˜ : ${sourceUrl} )`;
                    else lyricsBody = `( ì¶œì²˜ : ${sourceUrl} )`;
                }
                s.lyrics = lyricsBody;

                renderList();
                
                if(!isSilent) {
                    // ì €ì¥ í™•ì¸ ë©”ì‹œì§€
                    alert(`ì €ì¥ë¨!\n\nì œëª©: ${s.title}\nì½”ë©˜íŠ¸: ${s.comment ? s.comment : "(ì—†ìŒ)"}`);
                }
                
            } catch (err) {
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ! : " + err.message);
            }
        }

        function deleteSong() {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                loadedSongs.splice(currentIndex, 1);
                document.getElementById('editForm').classList.add('hidden');
                renderList();
                currentIndex = -1;
            }
        }

        function exportData() {
            // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë‚´ìš© ê°•ì œ ì €ì¥
            if (currentIndex !== -1) {
                saveSong(true); 
            }

            const json = loadedSongs.map(s => {
                const safeTitle = (s.title || "").replace(/"/g, '\\"');
                const safeArtist = (s.artist || "").replace(/"/g, '\\"');
                const safeLyrics = (s.lyrics || "").replace(/`/g, "\\`");
                // ì½”ë©˜íŠ¸ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                const safeComment = (s.comment || "").replace(/"/g, '\\"');
                const hashtagsJson = JSON.stringify(s.hashtags || []);
                
                return `    {
        id: ${s.id},
        title: "${safeTitle}",
        artist: "${safeArtist}",
        link: "${s.link}",
        hashtags: ${hashtagsJson},
        comment: "${safeComment}",
        lyrics: \`${safeLyrics}\`
    }`;
            }).join(',\n');
            
            const code = `export const playlistData = [\n${json}\n];`;
            const area = document.getElementById('exportArea');
            area.classList.remove('hidden');
            document.getElementById('exportResult').value = code;
            area.scrollIntoView({behavior: "smooth"});
        }

        function copyExport() {
            const el = document.getElementById('exportResult');
            el.select();
            document.execCommand('copy');
            alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }
    </script>
</body>
</html>
