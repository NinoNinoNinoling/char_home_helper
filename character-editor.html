<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï∫êÎ¶≠ÌÑ∞ Ìé∏ÏßëÍ∏∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="utils.js"></script>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-100">

    <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <nav class="bg-white border-b px-6 py-3 flex justify-between items-center z-10 shrink-0 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-slate-500 hover:text-indigo-600">
                <i data-lucide="arrow-left"></i>
            </a>
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="user-cog" class="text-purple-600"></i>
                Ï∫êÎ¶≠ÌÑ∞ Ìé∏ÏßëÍ∏∞
            </h1>
        </div>
        <button onclick="exportData()" class="btn btn-success">
            <i data-lucide="save" class="w-4 h-4"></i> ÏΩîÎìú ÏÉùÏÑ±
        </button>
    </nav>

    <!-- Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ -->
    <div class="bg-white border-b p-4 shrink-0">
        <label class="form-label">üìÇ character.js ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞</label>
        <div class="flex gap-2 relative">
            <textarea id="inputCode" rows="1" class="form-input flex-1 h-10 resize-none" 
                placeholder="export const characterData = {...} ÌòïÏãùÏùò ÏΩîÎìúÎ•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî"></textarea>
            <button onclick="loadData()" class="btn btn-secondary">Î∂àÎü¨Ïò§Í∏∞</button>
            <button onclick="startNew()" class="btn btn-primary">ÏÉàÎ°ú ÏãúÏûë</button>
            <div id="inputBlocker" class="absolute inset-0 bg-gray-100/80 hidden flex items-center justify-center text-xs font-bold text-gray-500 cursor-not-allowed">
                Ïù¥ÎØ∏ Î∂àÎü¨ÏôîÏäµÎãàÎã§
            </div>
        </div>
    </div>

    <!-- Î©îÏù∏ ÏòÅÏó≠ -->
    <div class="flex-1 overflow-hidden grid grid-cols-12">
        <!-- Ï¢åÏ∏°: ÏÑπÏÖò Î©îÎâ¥ -->
        <div class="col-span-3 bg-white border-r flex flex-col overflow-hidden">
            <div class="p-3 bg-slate-50 border-b">
                <span class="font-bold text-sm text-slate-700">ÏÑπÏÖò ÏÑ†ÌÉù</span>
            </div>
            <div id="sectionList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-slate-50">
                <div class="text-center text-gray-400 text-xs mt-10">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôÄÏ£ºÏÑ∏Ïöî</div>
            </div>
        </div>

        <!-- Ïö∞Ï∏°: Ìé∏Ïßë ÏòÅÏó≠ -->
        <div class="col-span-9 bg-slate-50 overflow-y-auto p-6" id="rightPanel">
            <!-- Í≥µÌÜµ Ï†ïÎ≥¥ Ìé∏Ïßë -->
            <div id="commonForm" class="hidden max-w-3xl mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h2 class="font-bold text-slate-700">üåê Í≥µÌÜµ Ï†ïÎ≥¥ (common)</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ÏÉùÏùº</label>
                                <input type="text" id="common_birthday" class="form-input" placeholder="11Ïõî 29Ïùº">
                            </div>
                            <div>
                                <label class="form-label">ÌÉÑÏÉùÌôî</label>
                                <input type="text" id="common_birthFlower" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ÌÉÑÏÉùÎ™©</label>
                                <input type="text" id="common_birthTree" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">ÌÉÑÏÉùÏÑù</label>
                                <input type="text" id="common_birthStone" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ÌÉÑÏÉùÏÉâ Ïù¥Î¶Ñ</label>
                                <input type="text" id="common_birthColorName" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">ÌÉÑÏÉùÏÉâ HEX</label>
                                <div class="flex gap-2">
                                    <input type="color" id="common_birthColorPicker" class="w-10 h-10 rounded cursor-pointer">
                                    <input type="text" id="common_birthColorHex" class="form-input flex-1" placeholder="#8B0000">
                                </div>
                            </div>
                        </div>
                        <div class="border-t pt-4 mt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">ü™Ñ ÏßÄÌå°Ïù¥ Ï†ïÎ≥¥</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">Î™©Ïû¨</label>
                                    <input type="text" id="common_wandWood" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">Ïã¨</label>
                                    <input type="text" id="common_wandCore" class="form-input">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label class="form-label">Í∏∏Ïù¥</label>
                                    <input type="text" id="common_wandLength" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">Ïú†Ïó∞ÏÑ±</label>
                                    <input type="text" id="common_wandFlexibility" class="form-input">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 border-t pt-4">
                            <div>
                                <label class="form-label">ÌòàÌÜµ</label>
                                <input type="text" id="common_bloodStatus" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Î™®ÏóêÌôî</label>
                                <input type="text" id="common_moehua" class="form-input">
                            </div>
                        </div>
                        <div class="pt-4 border-t flex justify-end">
                            <button onclick="saveCommon()" class="btn btn-primary">
                                <i data-lucide="check" class="w-4 h-4"></i> Ï†ÅÏö©
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÎÇòÏù¥Î≥Ñ ÌîÑÎ°úÌïÑ Ìé∏Ïßë -->
            <div id="profileForm" class="hidden max-w-3xl mx-auto">
                <div class="card">
                    <div class="card-header flex justify-between items-center">
                        <h2 class="font-bold text-slate-700">üë§ ÌîÑÎ°úÌïÑ: <span id="profileAge">-</span></h2>
                        <button onclick="deleteProfile()" class="btn btn-danger text-xs">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> ÏÇ≠Ï†ú
                        </button>
                    </div>
                    <div class="card-body space-y-4">
                        <!-- ÌÉ≠ ÎùºÎ≤® & ÌÖåÎßà -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ÌÉ≠ ÎùºÎ≤®</label>
                                <input type="text" id="profile_tabLabel" class="form-input" placeholder="1ÌïôÎÖÑ (11ÏÑ∏)">
                            </div>
                            <div>
                                <label class="form-label">ÌÖåÎßà ÏÉâÏÉÅ</label>
                                <div class="flex gap-2">
                                    <input type="color" id="profile_themeColorPicker" class="w-10 h-10 rounded cursor-pointer">
                                    <input type="text" id="profile_themeColor" class="form-input flex-1" placeholder="#FFD800">
                                </div>
                            </div>
                        </div>

                        <!-- Ïù¥Î¶Ñ -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Ïù¥Î¶Ñ (ÌïúÍ∏Ä)</label>
                                <input type="text" id="profile_nameKr" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Ïù¥Î¶Ñ (ÏòÅÎ¨∏)</label>
                                <input type="text" id="profile_nameEn" class="form-input">
                            </div>
                        </div>

                        <!-- Ïù¥ÎØ∏ÏßÄ -->
                        <div>
                            <label class="form-label">Ïù¥ÎØ∏ÏßÄ URL</label>
                            <input type="text" id="profile_image" class="form-input" placeholder="https://...">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Ïù¥ÎØ∏ÏßÄ ÌÅ¨Î†àÎîß</label>
                                <input type="text" id="profile_imageCreditText" class="form-input" placeholder="@ÏûëÍ∞ÄÎ™Ö">
                            </div>
                            <div>
                                <label class="form-label">ÌÅ¨Î†àÎîß URL</label>
                                <input type="text" id="profile_imageCreditUrl" class="form-input">
                            </div>
                        </div>

                        <!-- ÏÜåÏÜç -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ÏÜåÏÜç ÌÉÄÏûÖ</label>
                                <select id="profile_affiliationType" class="form-input">
                                    <option value="house">Í∏∞ÏàôÏÇ¨ (house)</option>
                                    <option value="order">Í∏∞ÏÇ¨Îã® (order)</option>
                                    <option value="faction">ÏßÑÏòÅ (faction)</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">ÏÜåÏÜç Ïù¥Î¶Ñ</label>
                                <input type="text" id="profile_affiliationName" class="form-input" placeholder="HUFFLEPUFF">
                            </div>
                        </div>

                        <!-- Î™ÖÏ†ú -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">üìú Î™ÖÏ†ú</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">Î≤àÌò∏</label>
                                    <input type="text" id="profile_propNumber" class="form-input" placeholder="Ï†ú 1 Î™ÖÏ†ú">
                                </div>
                                <div>
                                    <label class="form-label">ÌïúÏûê</label>
                                    <input type="text" id="profile_propKanji" class="form-input" placeholder="ÂÆö">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">ÏÑ§Î™Ö (HTML ÌÉúÍ∑∏ Í∞ÄÎä•)</label>
                                <input type="text" id="profile_propDesc" class="form-input" placeholder="Î™®Îì† <em>ÎØ∏Îûò</em>Îäî Î∂àÎ≥ÄÌïúÎã§.">
                            </div>
                        </div>

                        <!-- ÌïúÎßàÎîî -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">üí¨ ÌïúÎßàÎîî</h3>
                            <div>
                                <label class="form-label">Î©îÏù∏ (HTML ÌÉúÍ∑∏ Í∞ÄÎä•)</label>
                                <input type="text" id="profile_quoteMain" class="form-input">
                            </div>
                            <div class="mt-3">
                                <label class="form-label">ÏÑúÎ∏å</label>
                                <input type="text" id="profile_quoteSub" class="form-input">
                            </div>
                            <div class="mt-3">
                                <label class="form-label">ÏÑ§Î™Ö (Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂Ñ)</label>
                                <textarea id="profile_quoteDesc" rows="3" class="form-input form-textarea"></textarea>
                            </div>
                        </div>

                        <!-- ÏÑ±Í≤© -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">üé≠ ÏÑ±Í≤©</h3>
                            <div>
                                <label class="form-label">ÌÉúÍ∑∏ (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)</label>
                                <input type="text" id="profile_personalityTags" class="form-input" placeholder="#Î¨¥Ïã†Í≤Ω, #Î¨¥Î∞òÏùë, #Î¨¥Í∞êÍ∞Å">
                            </div>
                            <div class="mt-3">
                                <label class="form-label">ÏÑ§Î™Ö (Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂Ñ)</label>
                                <textarea id="profile_personalityDesc" rows="4" class="form-input form-textarea"></textarea>
                            </div>
                        </div>

                        <!-- Í∏∞Î≥∏ Ïä§ÌÉØ -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">üìä Í∏∞Î≥∏ Ïä§ÌÉØ</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="form-label">ÎÇòÏù¥</label>
                                    <input type="text" id="profile_basicAge" class="form-input" placeholder="11ÏÑ∏ (1ÌïôÎÖÑ)">
                                </div>
                                <div>
                                    <label class="form-label">ÌÇ§</label>
                                    <input type="text" id="profile_basicHeight" class="form-input" placeholder="130cm">
                                </div>
                                <div>
                                    <label class="form-label">Ï≤¥Ï§ë</label>
                                    <input type="text" id="profile_basicWeight" class="form-input" placeholder="25kg">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label class="form-label">Í∏∞ÏàôÏÇ¨/ÏßÑÏòÅ</label>
                                    <input type="text" id="profile_basicHouse" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">Íµ≠Ï†Å</label>
                                    <input type="text" id="profile_basicNationality" class="form-input">
                                </div>
                            </div>
                        </div>

                        <!-- Î¨¥ÎìúÍ≥° -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">üéµ Î¨¥ÎìúÍ≥°</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">Ï†úÎ™©</label>
                                    <input type="text" id="profile_moodSongTitle" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">ÏïÑÌã∞Ïä§Ìä∏</label>
                                    <input type="text" id="profile_moodSongArtist" class="form-input">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">URL</label>
                                <input type="text" id="profile_moodSongUrl" class="form-input">
                            </div>
                        </div>

                        <!-- Î∞∞Í≤ΩÏùåÏïÖ -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">üîä Î∞∞Í≤Ω ÏùåÏïÖ</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">YouTube ID</label>
                                    <input type="text" id="profile_bgMusicId" class="form-input" placeholder="dQw4w9WgXcQ">
                                </div>
                                <div>
                                    <label class="form-label">Ï†úÎ™©</label>
                                    <input type="text" id="profile_bgMusicTitle" class="form-input">
                                </div>
                            </div>
                        </div>

                        <!-- Í¥ÄÍ≥Ñ -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3 flex justify-between items-center">
                                <span>üë• Í¥ÄÍ≥Ñ</span>
                                <button onclick="addRelation()" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded">+ Ï∂îÍ∞Ä</button>
                            </h3>
                            <div id="relationsContainer" class="space-y-3"></div>
                        </div>

                        <div class="pt-4 border-t flex justify-end">
                            <button onclick="saveProfile()" class="btn btn-primary">
                                <i data-lucide="check" class="w-4 h-4"></i> Ï†ÅÏö©
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÏÉà ÌîÑÎ°úÌïÑ Ï∂îÍ∞Ä -->
            <div id="addProfileForm" class="hidden max-w-md mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h2 class="font-bold text-slate-700">‚ûï ÏÉà ÌîÑÎ°úÌïÑ Ï∂îÍ∞Ä</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div>
                            <label class="form-label">ÎÇòÏù¥ (Ïà´Ïûê, ÌÇ§Í∞íÏúºÎ°ú ÏÇ¨Ïö©)</label>
                            <input type="number" id="newProfileAge" class="form-input" placeholder="11">
                        </div>
                        <button onclick="createProfile()" class="btn btn-primary w-full">ÏÉùÏÑ±</button>
                    </div>
                </div>
            </div>

            <!-- ÏΩîÎìú Ï∂úÎ†• -->
            <div id="exportArea" class="hidden mt-6 code-output max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-green-400 font-bold">‚úÖ ÏΩîÎìú ÏÉùÏÑ± ÏôÑÎ£å</span>
                    <button onclick="copyCode()" class="btn btn-success text-sm">üìã Î≥µÏÇ¨</button>
                </div>
                <textarea id="exportResult" rows="20" class="w-full" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let data = null;
        let currentSection = null;
        let currentAge = null;

        function startNew() {
            data = {
                common: {
                    birthday: "",
                    birthFlower: "",
                    birthTree: "",
                    birthStone: "",
                    birthColor: { name: "", hex: "#000000" },
                    wand: { wood: "", core: "", length: "", flexibility: "" },
                    bloodStatus: "",
                    moehua: ""
                },
                profiles: {}
            };
            renderSections();
            document.getElementById('inputBlocker').classList.remove('hidden');
            document.getElementById('inputCode').disabled = true;
            HelperUtils.showToast('ÏÉà Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏãúÏûë! ÌîÑÎ°úÌïÑÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.', 'success');
        }

        function loadData() {
            const raw = document.getElementById('inputCode').value.trim();
            if (!raw) return alert('ÏΩîÎìúÎ•º Î∂ôÏó¨ÎÑ£Ïñ¥ Ï£ºÏÑ∏Ïöî.');
            
            try {
                data = HelperUtils.parseExportData(raw, 'characterData');
                renderSections();
                document.getElementById('inputBlocker').classList.remove('hidden');
                document.getElementById('inputCode').disabled = true;
                HelperUtils.showToast('Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å!', 'success');
            } catch (e) {
                alert('Î°úÎìú Ïã§Ìå®: ' + e.message);
            }
        }

        function renderSections() {
            const list = document.getElementById('sectionList');
            const ages = Object.keys(data.profiles || {});
            
            list.innerHTML = `
                <div class="list-item ${currentSection === 'common' ? 'active' : ''}" onclick="showCommon()">
                    <span class="font-medium text-sm">üåê Í≥µÌÜµ Ï†ïÎ≥¥</span>
                </div>
                <div class="text-xs text-slate-500 mt-3 mb-1 px-2">ÎÇòÏù¥Î≥Ñ ÌîÑÎ°úÌïÑ</div>
                ${ages.map(age => `
                    <div class="list-item ${currentSection === 'profile' && currentAge === age ? 'active' : ''}" onclick="showProfile('${age}')">
                        <span class="font-medium text-sm">${data.profiles[age].tabLabel || age + 'ÏÑ∏'}</span>
                    </div>
                `).join('')}
                <div class="list-item mt-2" onclick="showAddProfile()">
                    <span class="text-indigo-600 font-medium text-sm">+ ÏÉà ÌîÑÎ°úÌïÑ Ï∂îÍ∞Ä</span>
                </div>
            `;
        }

        function hideAllForms() {
            document.getElementById('commonForm').classList.add('hidden');
            document.getElementById('profileForm').classList.add('hidden');
            document.getElementById('addProfileForm').classList.add('hidden');
            document.getElementById('exportArea').classList.add('hidden');
        }

        function showCommon() {
            hideAllForms();
            currentSection = 'common';
            currentAge = null;
            
            const c = data.common;
            document.getElementById('common_birthday').value = c.birthday || '';
            document.getElementById('common_birthFlower').value = c.birthFlower || '';
            document.getElementById('common_birthTree').value = c.birthTree || '';
            document.getElementById('common_birthStone').value = c.birthStone || '';
            document.getElementById('common_birthColorName').value = c.birthColor?.name || '';
            document.getElementById('common_birthColorHex').value = c.birthColor?.hex || '';
            document.getElementById('common_birthColorPicker').value = c.birthColor?.hex || '#000000';
            document.getElementById('common_wandWood').value = c.wand?.wood || '';
            document.getElementById('common_wandCore').value = c.wand?.core || '';
            document.getElementById('common_wandLength').value = c.wand?.length || '';
            document.getElementById('common_wandFlexibility').value = c.wand?.flexibility || '';
            document.getElementById('common_bloodStatus').value = c.bloodStatus || '';
            document.getElementById('common_moehua').value = c.moehua || '';
            
            document.getElementById('commonForm').classList.remove('hidden');
            renderSections();
        }

        function saveCommon() {
            data.common = {
                birthday: document.getElementById('common_birthday').value,
                birthFlower: document.getElementById('common_birthFlower').value,
                birthTree: document.getElementById('common_birthTree').value,
                birthStone: document.getElementById('common_birthStone').value,
                birthColor: {
                    name: document.getElementById('common_birthColorName').value,
                    hex: document.getElementById('common_birthColorHex').value
                },
                wand: {
                    wood: document.getElementById('common_wandWood').value,
                    core: document.getElementById('common_wandCore').value,
                    length: document.getElementById('common_wandLength').value,
                    flexibility: document.getElementById('common_wandFlexibility').value
                },
                bloodStatus: document.getElementById('common_bloodStatus').value,
                moehua: document.getElementById('common_moehua').value
            };
            HelperUtils.showToast('Ï†ÄÏû•Îê®', 'success');
        }

        function showProfile(age) {
            hideAllForms();
            currentSection = 'profile';
            currentAge = age;
            
            const p = data.profiles[age];
            document.getElementById('profileAge').textContent = p.tabLabel || age + 'ÏÑ∏';
            
            document.getElementById('profile_tabLabel').value = p.tabLabel || '';
            document.getElementById('profile_themeColor').value = p.themeColor || '';
            document.getElementById('profile_themeColorPicker').value = p.themeColor || '#000000';
            document.getElementById('profile_nameKr').value = p.name?.kr || '';
            document.getElementById('profile_nameEn').value = p.name?.en || '';
            document.getElementById('profile_image').value = p.image || '';
            document.getElementById('profile_imageCreditText').value = p.imageCredit?.text || '';
            document.getElementById('profile_imageCreditUrl').value = p.imageCredit?.url || '';
            document.getElementById('profile_affiliationType').value = p.affiliation?.type || 'house';
            document.getElementById('profile_affiliationName').value = p.affiliation?.name || '';
            document.getElementById('profile_propNumber').value = p.proposition?.number || '';
            document.getElementById('profile_propKanji').value = p.proposition?.kanji || '';
            document.getElementById('profile_propDesc').value = p.proposition?.description || '';
            document.getElementById('profile_quoteMain').value = p.quote?.main || '';
            document.getElementById('profile_quoteSub').value = p.quote?.sub || '';
            document.getElementById('profile_quoteDesc').value = (p.quote?.description || []).join('\n');
            document.getElementById('profile_personalityTags').value = (p.personality?.tags || []).join(', ');
            document.getElementById('profile_personalityDesc').value = (p.personality?.description || []).join('\n');
            document.getElementById('profile_basicAge').value = p.basic?.age || '';
            document.getElementById('profile_basicHeight').value = p.basic?.height || '';
            document.getElementById('profile_basicWeight').value = p.basic?.weight || '';
            document.getElementById('profile_basicHouse').value = p.basic?.house || p.basic?.faction || '';
            document.getElementById('profile_basicNationality').value = p.basic?.nationality || '';
            document.getElementById('profile_moodSongTitle').value = p.magic?.moodSong?.title || '';
            document.getElementById('profile_moodSongArtist').value = p.magic?.moodSong?.artist || '';
            document.getElementById('profile_moodSongUrl').value = p.magic?.moodSong?.url || '';
            document.getElementById('profile_bgMusicId').value = p.bgMusic?.youtubeId || '';
            document.getElementById('profile_bgMusicTitle').value = p.bgMusic?.title || '';
            
            renderRelations(p.relationships || []);
            
            document.getElementById('profileForm').classList.remove('hidden');
            renderSections();
        }

        function renderRelations(relations) {
            const container = document.getElementById('relationsContainer');
            if (relations.length === 0) {
                container.innerHTML = '<div class="text-sm text-slate-400">Îì±Î°ùÎêú Í¥ÄÍ≥ÑÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            container.innerHTML = relations.map((rel, idx) => `
                <div class="bg-slate-50 p-3 rounded border space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">${rel.name}</span>
                        <button onclick="removeRelation(${idx})" class="text-red-500 text-xs">ÏÇ≠Ï†ú</button>
                    </div>
                    <input type="text" class="form-input text-sm rel-name" value="${rel.name || ''}" placeholder="Ïù¥Î¶Ñ">
                    <input type="text" class="form-input text-sm rel-initial" value="${rel.initial || ''}" placeholder="Ïù¥ÎãàÏÖú">
                    <textarea class="form-input form-textarea text-sm rel-detail" rows="2" placeholder="ÏÑ§Î™Ö">${rel.detail || ''}</textarea>
                </div>
            `).join('');
        }

        function addRelation() {
            const p = data.profiles[currentAge];
            if (!p.relationships) p.relationships = [];
            p.relationships.push({ name: 'ÏÉà Í¥ÄÍ≥Ñ', initial: '', detail: '' });
            renderRelations(p.relationships);
        }

        function removeRelation(idx) {
            const p = data.profiles[currentAge];
            p.relationships.splice(idx, 1);
            renderRelations(p.relationships);
        }

        function saveProfile() {
            const p = data.profiles[currentAge];
            
            p.tabLabel = document.getElementById('profile_tabLabel').value;
            p.themeColor = document.getElementById('profile_themeColor').value;
            p.name = {
                kr: document.getElementById('profile_nameKr').value,
                en: document.getElementById('profile_nameEn').value
            };
            p.image = document.getElementById('profile_image').value;
            p.imageCredit = {
                text: document.getElementById('profile_imageCreditText').value,
                url: document.getElementById('profile_imageCreditUrl').value
            };
            p.affiliation = {
                type: document.getElementById('profile_affiliationType').value,
                name: document.getElementById('profile_affiliationName').value
            };
            p.proposition = {
                number: document.getElementById('profile_propNumber').value,
                kanji: document.getElementById('profile_propKanji').value,
                description: document.getElementById('profile_propDesc').value
            };
            p.quote = {
                main: document.getElementById('profile_quoteMain').value,
                sub: document.getElementById('profile_quoteSub').value || null,
                description: document.getElementById('profile_quoteDesc').value.split('\n').filter(l => l.trim() !== '' || l === '')
            };
            p.personality = {
                tags: document.getElementById('profile_personalityTags').value.split(',').map(t => t.trim()).filter(t => t),
                description: document.getElementById('profile_personalityDesc').value.split('\n')
            };
            p.basic = {
                age: document.getElementById('profile_basicAge').value,
                height: document.getElementById('profile_basicHeight').value,
                weight: document.getElementById('profile_basicWeight').value,
                house: document.getElementById('profile_basicHouse').value,
                nationality: document.getElementById('profile_basicNationality').value
            };
            p.magic = {
                moodSong: {
                    title: document.getElementById('profile_moodSongTitle').value,
                    artist: document.getElementById('profile_moodSongArtist').value,
                    url: document.getElementById('profile_moodSongUrl').value
                }
            };
            p.bgMusic = {
                youtubeId: document.getElementById('profile_bgMusicId').value,
                title: document.getElementById('profile_bgMusicTitle').value
            };
            
            // Í¥ÄÍ≥Ñ Ï†ÄÏû•
            const relEls = document.getElementById('relationsContainer').querySelectorAll('.bg-slate-50');
            p.relationships = Array.from(relEls).map(el => ({
                name: el.querySelector('.rel-name').value,
                initial: el.querySelector('.rel-initial').value,
                detail: el.querySelector('.rel-detail').value
            }));
            
            renderSections();
            HelperUtils.showToast('Ï†ÄÏû•Îê®', 'success');
        }

        function showAddProfile() {
            hideAllForms();
            currentSection = 'add';
            document.getElementById('addProfileForm').classList.remove('hidden');
            renderSections();
        }

        function createProfile() {
            const age = document.getElementById('newProfileAge').value;
            if (!age) return alert('ÎÇòÏù¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
            if (data.profiles[age]) return alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÎÇòÏù¥ÏûÖÎãàÎã§.');
            
            data.profiles[age] = {
                tabLabel: `${age}ÏÑ∏`,
                themeColor: '#888888',
                name: { kr: '', en: '' },
                image: '',
                imageCredit: { text: '', url: '' },
                affiliation: { type: 'house', name: '' },
                proposition: { number: '', kanji: '', description: '' },
                quote: { main: '', sub: null, description: [] },
                personality: { tags: [], description: [] },
                basic: { age: '', height: '', weight: '', house: '', nationality: '' },
                magic: { moodSong: { title: '', artist: '', url: '' } },
                relationships: [],
                bgMusic: { youtubeId: '', title: '' }
            };
            
            showProfile(age);
            HelperUtils.showToast('ÌîÑÎ°úÌïÑ ÏÉùÏÑ±Îê®', 'success');
        }

        function deleteProfile() {
            if (!confirm(`${currentAge}ÏÑ∏ ÌîÑÎ°úÌïÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
            delete data.profiles[currentAge];
            hideAllForms();
            currentSection = null;
            currentAge = null;
            renderSections();
        }

        function exportData() {
            if (currentSection === 'common') saveCommon();
            if (currentSection === 'profile') saveProfile();
            
            const code = HelperUtils.generateCharacterCode(data);
            document.getElementById('exportArea').classList.remove('hidden');
            document.getElementById('exportResult').value = code;
            document.getElementById('exportArea').scrollIntoView({ behavior: 'smooth' });
        }

        function copyCode() {
            HelperUtils.copyToClipboard(document.getElementById('exportResult').value);
            HelperUtils.showToast('Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
        }

        // ÏÉâÏÉÅ ÌîºÏª§ ÎèôÍ∏∞Ìôî
        document.getElementById('common_birthColorPicker').addEventListener('input', e => {
            document.getElementById('common_birthColorHex').value = e.target.value;
        });
        document.getElementById('profile_themeColorPicker').addEventListener('input', e => {
            document.getElementById('profile_themeColor').value = e.target.value;
        });
    </script>
</body>
</html>
