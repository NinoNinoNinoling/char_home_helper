<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºë¦­í„° í¸ì§‘ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="utils.js"></script>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-100">

    <nav class="bg-white border-b px-6 py-3 flex justify-between items-center z-10 shrink-0 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-slate-500 hover:text-indigo-600"><i data-lucide="arrow-left"></i></a>
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="user-cog" class="text-purple-600"></i> ìºë¦­í„° í¸ì§‘ê¸°
            </h1>
        </div>
        <button onclick="exportData()" class="btn btn-success" id="exportBtn" disabled>
            <i data-lucide="save" class="w-4 h-4"></i> ì½”ë“œ ìƒì„±
        </button>
    </nav>

    <!-- Step 1: Config ì…ë ¥ -->
    <div id="step1" class="bg-white border-b p-4 shrink-0">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded">STEP 1</span>
                <label class="form-label mb-0">config.js ì½”ë“œ ë¨¼ì € ë¶™ì—¬ë„£ê¸°</label>
            </div>
            <div class="flex gap-2">
                <textarea id="configCode" rows="1" class="form-input flex-1 h-10 resize-none" 
                    placeholder="export const config = {...}"></textarea>
                <button onclick="loadConfig()" class="btn btn-primary">Config ë¡œë“œ</button>
            </div>
        </div>
    </div>

    <!-- Step 2: Character ì…ë ¥ (Config ë¡œë“œ í›„ í™œì„±í™”) -->
    <div id="step2" class="bg-slate-50 border-b p-4 shrink-0 hidden">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded">STEP 2</span>
                <label class="form-label mb-0">character.js ì½”ë“œ ë¶™ì—¬ë„£ê¸° (ë˜ëŠ” ìƒˆë¡œ ì‹œì‘)</label>
            </div>
            <div class="flex gap-2">
                <textarea id="characterCode" rows="1" class="form-input flex-1 h-10 resize-none" 
                    placeholder="export const characterData = {...}"></textarea>
                <button onclick="loadCharacter()" class="btn btn-secondary">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="startNew()" class="btn btn-primary">ìƒˆë¡œ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div class="flex-1 overflow-hidden grid grid-cols-12">
        <div class="col-span-3 bg-white border-r flex flex-col overflow-hidden">
            <div class="p-3 bg-slate-50 border-b font-bold text-sm text-slate-700">ì„¹ì…˜</div>
            <div id="sectionList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-slate-50">
                <div class="text-center text-gray-400 text-xs mt-10">Configë¥¼ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”</div>
            </div>
        </div>

        <div class="col-span-9 bg-slate-50 overflow-y-auto p-6" id="rightPanel">
            <!-- ê³µí†µ ì •ë³´ (ë™ì  ìƒì„±) -->
            <div id="commonForm" class="hidden max-w-3xl mx-auto card">
                <div class="card-header"><h2 class="font-bold">ğŸŒ ê³µí†µ ì •ë³´ (common)</h2></div>
                <div class="card-body" id="commonFields"></div>
            </div>

            <!-- í”„ë¡œí•„ í¸ì§‘ (ë™ì  ìƒì„±) -->
            <div id="profileForm" class="hidden max-w-3xl mx-auto card">
                <div class="card-header flex justify-between items-center">
                    <h2 class="font-bold">ğŸ‘¤ í”„ë¡œí•„: <span id="profileKey">-</span></h2>
                    <button onclick="deleteProfile()" class="btn btn-danger text-xs">ì‚­ì œ</button>
                </div>
                <div class="card-body" id="profileFields"></div>
            </div>

            <!-- ìƒˆ í”„ë¡œí•„ ì¶”ê°€ -->
            <div id="addProfileForm" class="hidden max-w-md mx-auto card">
                <div class="card-header"><h2 class="font-bold">â• ìƒˆ í”„ë¡œí•„ ì¶”ê°€</h2></div>
                <div class="card-body space-y-4">
                    <div>
                        <label class="form-label">í”„ë¡œí•„ í‚¤ (ë‚˜ì´, ìºë¦­í„°ëª… ë“±)</label>
                        <input type="text" id="newProfileKey" class="form-input" placeholder="11, characterA ë“±">
                    </div>
                    <button onclick="createProfile()" class="btn btn-primary w-full">ìƒì„±</button>
                </div>
            </div>

            <!-- ì½”ë“œ ì¶œë ¥ -->
            <div id="exportArea" class="hidden mt-6 code-output max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-green-400 font-bold">âœ… ì½”ë“œ ìƒì„± ì™„ë£Œ</span>
                    <button onclick="copyCode()" class="btn btn-success text-sm">ğŸ“‹ ë³µì‚¬</button>
                </div>
                <textarea id="exportResult" rows="20" class="w-full" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let configData = null;
        let characterData = null;
        let currentSection = null;
        let currentKey = null;

        // ==========================================
        // Config ë¡œë“œ
        // ==========================================
        function loadConfig() {
            const raw = document.getElementById('configCode').value.trim();
            if (!raw) return alert('config.js ì½”ë“œë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.');
            
            try {
                configData = HelperUtils.parseExportData(raw, 'config');
                if (!configData.fieldDefinitions) {
                    alert('fieldDefinitionsê°€ ì—†ìŠµë‹ˆë‹¤. configì— í•„ë“œ ì •ì˜ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                    return;
                }
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                HelperUtils.showToast('Config ë¡œë“œ ì™„ë£Œ! ì´ì œ ìºë¦­í„° ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì„¸ìš”.', 'success');
            } catch (e) {
                alert('Config íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
            }
        }

        // ==========================================
        // Character ë¡œë“œ/ìƒì„±
        // ==========================================
        function loadCharacter() {
            const raw = document.getElementById('characterCode').value.trim();
            if (!raw) return alert('character.js ì½”ë“œë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.');
            
            try {
                characterData = HelperUtils.parseExportData(raw, 'characterData');
                initEditor();
                HelperUtils.showToast('ìºë¦­í„° ë°ì´í„° ë¡œë“œ ì™„ë£Œ!', 'success');
            } catch (e) {
                alert('íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
            }
        }

        function startNew() {
            // config ê¸°ë°˜ìœ¼ë¡œ ë¹ˆ common ìƒì„±
            const common = {};
            (configData.fieldDefinitions.common || []).forEach(field => {
                if (field.type === 'group') {
                    common[field.key] = {};
                    field.fields.forEach(f => common[field.key][f.key] = '');
                } else if (field.type === 'color') {
                    common[field.key] = { name: '', hex: '#000000' };
                } else {
                    common[field.key] = '';
                }
            });
            
            characterData = { common, profiles: {} };
            initEditor();
            HelperUtils.showToast('ìƒˆ ìºë¦­í„° ë°ì´í„° ì‹œì‘!', 'success');
        }

        function initEditor() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('exportBtn').disabled = false;
            renderSections();
        }

        // ==========================================
        // ì„¹ì…˜ ëª©ë¡ ë Œë”ë§
        // ==========================================
        function renderSections() {
            const list = document.getElementById('sectionList');
            const keys = Object.keys(characterData.profiles || {});
            
            list.innerHTML = `
                <div class="list-item ${currentSection === 'common' ? 'active' : ''}" onclick="showCommon()">
                    <span class="font-medium text-sm">ğŸŒ ê³µí†µ ì •ë³´</span>
                </div>
                <div class="text-xs text-slate-500 mt-3 mb-1 px-2">í”„ë¡œí•„ ëª©ë¡</div>
                ${keys.map(key => `
                    <div class="list-item ${currentSection === 'profile' && currentKey === key ? 'active' : ''}" onclick="showProfile('${key}')">
                        <span class="font-medium text-sm">${characterData.profiles[key].tabLabel || key}</span>
                    </div>
                `).join('')}
                <div class="list-item mt-2" onclick="showAddProfile()">
                    <span class="text-indigo-600 font-medium text-sm">+ ìƒˆ í”„ë¡œí•„ ì¶”ê°€</span>
                </div>
            `;
        }

        function hideAllForms() {
            ['commonForm', 'profileForm', 'addProfileForm', 'exportArea'].forEach(id =>
                document.getElementById(id).classList.add('hidden'));
        }

        // ==========================================
        // Common í¼ (ë™ì  ìƒì„±)
        // ==========================================
        function showCommon() {
            hideAllForms();
            currentSection = 'common';
            currentKey = null;
            
            const fields = configData.fieldDefinitions.common || [];
            const container = document.getElementById('commonFields');
            
            container.innerHTML = fields.map(field => renderField(field, characterData.common, 'common')).join('') + `
                <div class="pt-4 border-t flex justify-end mt-4">
                    <button onclick="saveCommon()" class="btn btn-primary">ì ìš©</button>
                </div>
            `;
            
            document.getElementById('commonForm').classList.remove('hidden');
            renderSections();
        }

        function saveCommon() {
            const fields = configData.fieldDefinitions.common || [];
            fields.forEach(field => {
                if (field.type === 'group') {
                    if (!characterData.common[field.key]) characterData.common[field.key] = {};
                    field.fields.forEach(f => {
                        const el = document.getElementById(`common_${field.key}_${f.key}`);
                        if (el) characterData.common[field.key][f.key] = el.value;
                    });
                } else if (field.type === 'color') {
                    characterData.common[field.key] = {
                        name: document.getElementById(`common_${field.key}_name`)?.value || '',
                        hex: document.getElementById(`common_${field.key}_hex`)?.value || ''
                    };
                } else {
                    const el = document.getElementById(`common_${field.key}`);
                    if (el) characterData.common[field.key] = el.value;
                }
            });
            HelperUtils.showToast('ì €ì¥ë¨', 'success');
        }

        // ==========================================
        // Profile í¼ (ë™ì  ìƒì„±)
        // ==========================================
        function showProfile(key) {
            hideAllForms();
            currentSection = 'profile';
            currentKey = key;
            
            const profile = characterData.profiles[key];
            const profileFields = configData.fieldDefinitions.profile || {};
            const container = document.getElementById('profileFields');
            document.getElementById('profileKey').textContent = profile.tabLabel || key;
            
            // ê³ ì • í•„ë“œ (í•­ìƒ ìˆìŒ)
            let html = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">íƒ­ ë¼ë²¨</label>
                            <input type="text" id="profile_tabLabel" class="form-input" value="${profile.tabLabel || ''}">
                        </div>
                        <div>
                            <label class="form-label">í…Œë§ˆ ìƒ‰ìƒ</label>
                            <div class="flex gap-2">
                                <input type="color" id="profile_themeColorPicker" class="w-10 h-10 rounded" value="${profile.themeColor || '#888888'}">
                                <input type="text" id="profile_themeColor" class="form-input flex-1" value="${profile.themeColor || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">ì´ë¦„ (í•œê¸€)</label>
                            <input type="text" id="profile_name_kr" class="form-input" value="${profile.name?.kr || ''}">
                        </div>
                        <div>
                            <label class="form-label">ì´ë¦„ (ì˜ë¬¸)</label>
                            <input type="text" id="profile_name_en" class="form-input" value="${profile.name?.en || ''}">
                        </div>
                    </div>
                    <div>
                        <label class="form-label">ì´ë¯¸ì§€ URL</label>
                        <input type="text" id="profile_image" class="form-input" value="${profile.image || ''}">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">ì´ë¯¸ì§€ í¬ë ˆë”§</label>
                            <input type="text" id="profile_imageCredit_text" class="form-input" value="${profile.imageCredit?.text || ''}">
                        </div>
                        <div>
                            <label class="form-label">í¬ë ˆë”§ URL</label>
                            <input type="text" id="profile_imageCredit_url" class="form-input" value="${profile.imageCredit?.url || ''}">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">ì†Œì† íƒ€ì…</label>
                            <select id="profile_affiliation_type" class="form-input">
                                <option value="house" ${profile.affiliation?.type === 'house' ? 'selected' : ''}>house</option>
                                <option value="order" ${profile.affiliation?.type === 'order' ? 'selected' : ''}>order</option>
                                <option value="faction" ${profile.affiliation?.type === 'faction' ? 'selected' : ''}>faction</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">ì†Œì† ì´ë¦„</label>
                            <input type="text" id="profile_affiliation_name" class="form-input" value="${profile.affiliation?.name || ''}">
                        </div>
                    </div>
            `;
            
            // ëª…ì œ
            html += `
                <div class="border-t pt-4 mt-4">
                    <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ“œ ëª…ì œ</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">ë²ˆí˜¸</label>
                            <input type="text" id="profile_proposition_number" class="form-input" value="${profile.proposition?.number || ''}">
                        </div>
                        <div>
                            <label class="form-label">í•œì</label>
                            <input type="text" id="profile_proposition_kanji" class="form-input" value="${profile.proposition?.kanji || ''}">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">ì„¤ëª…</label>
                        <input type="text" id="profile_proposition_description" class="form-input" value="${profile.proposition?.description || ''}">
                    </div>
                </div>
            `;
            
            // í•œë§ˆë””
            html += `
                <div class="border-t pt-4">
                    <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ’¬ í•œë§ˆë””</h3>
                    <div>
                        <label class="form-label">ë©”ì¸</label>
                        <input type="text" id="profile_quote_main" class="form-input" value="${profile.quote?.main || ''}">
                    </div>
                    <div class="mt-3">
                        <label class="form-label">ì„œë¸Œ</label>
                        <input type="text" id="profile_quote_sub" class="form-input" value="${profile.quote?.sub || ''}">
                    </div>
                    <div class="mt-3">
                        <label class="form-label">ì„¤ëª… (ì¤„ë°”ê¿ˆ êµ¬ë¶„)</label>
                        <textarea id="profile_quote_description" rows="3" class="form-input form-textarea">${(profile.quote?.description || []).join('\n')}</textarea>
                    </div>
                </div>
            `;
            
            // ì„±ê²©
            html += `
                <div class="border-t pt-4">
                    <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ­ ì„±ê²©</h3>
                    <div>
                        <label class="form-label">íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)</label>
                        <input type="text" id="profile_personality_tags" class="form-input" value="${(profile.personality?.tags || []).join(', ')}">
                    </div>
                    <div class="mt-3">
                        <label class="form-label">ì„¤ëª… (ì¤„ë°”ê¿ˆ êµ¬ë¶„)</label>
                        <textarea id="profile_personality_description" rows="4" class="form-input form-textarea">${(profile.personality?.description || []).join('\n')}</textarea>
                    </div>
                </div>
            `;
            
            // Config ê¸°ë°˜ basic í•„ë“œ
            const basicFields = profileFields.basic || [];
            if (basicFields.length > 0) {
                html += `<div class="border-t pt-4"><h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ“Š ê¸°ë³¸ ìŠ¤íƒ¯</h3><div class="grid grid-cols-2 gap-4">`;
                basicFields.forEach(field => {
                    const val = profile.basic?.[field.key] || '';
                    html += `
                        <div>
                            <label class="form-label">${field.label}</label>
                            <input type="text" id="profile_basic_${field.key}" class="form-input" value="${val}">
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Config ê¸°ë°˜ magic í•„ë“œ
            const magicFields = profileFields.magic || [];
            if (magicFields.length > 0) {
                html += `<div class="border-t pt-4"><h3 class="font-bold text-sm text-slate-600 mb-3">âœ¨ ì¶”ê°€ ì •ë³´</h3>`;
                magicFields.forEach(field => {
                    if (field.type === 'song') {
                        const song = profile.magic?.[field.key] || {};
                        html += `
                            <div class="mb-3">
                                <label class="form-label">${field.label}</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <input type="text" id="profile_magic_${field.key}_title" class="form-input" placeholder="ì œëª©" value="${song.title || ''}">
                                    <input type="text" id="profile_magic_${field.key}_artist" class="form-input" placeholder="ì•„í‹°ìŠ¤íŠ¸" value="${song.artist || ''}">
                                    <input type="text" id="profile_magic_${field.key}_url" class="form-input" placeholder="URL" value="${song.url || ''}">
                                </div>
                            </div>
                        `;
                    } else {
                        const val = profile.magic?.[field.key] || '';
                        html += `
                            <div class="mb-3">
                                <label class="form-label">${field.label}</label>
                                <input type="text" id="profile_magic_${field.key}" class="form-input" value="${val}">
                            </div>
                        `;
                    }
                });
                html += `</div>`;
            }
            
            // ë°°ê²½ìŒì•…
            html += `
                <div class="border-t pt-4">
                    <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ”Š ë°°ê²½ìŒì•…</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">YouTube ID</label>
                            <input type="text" id="profile_bgMusic_youtubeId" class="form-input" value="${profile.bgMusic?.youtubeId || ''}">
                        </div>
                        <div>
                            <label class="form-label">ì œëª©</label>
                            <input type="text" id="profile_bgMusic_title" class="form-input" value="${profile.bgMusic?.title || ''}">
                        </div>
                    </div>
                </div>
            `;
            
            // ê´€ê³„
            html += `
                <div class="border-t pt-4">
                    <h3 class="font-bold text-sm text-slate-600 mb-3 flex justify-between">
                        <span>ğŸ‘¥ ê´€ê³„</span>
                        <button onclick="addRelation()" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded">+ ì¶”ê°€</button>
                    </h3>
                    <div id="relationsContainer"></div>
                </div>
            `;
            
            html += `
                </div>
                <div class="pt-4 border-t flex justify-end mt-4">
                    <button onclick="saveProfile()" class="btn btn-primary">ì ìš©</button>
                </div>
            `;
            
            container.innerHTML = html;
            renderRelations(profile.relationships || []);
            
            // ìƒ‰ìƒ í”¼ì»¤ ë™ê¸°í™”
            document.getElementById('profile_themeColorPicker').addEventListener('input', e => {
                document.getElementById('profile_themeColor').value = e.target.value;
            });
            
            document.getElementById('profileForm').classList.remove('hidden');
            renderSections();
        }

        function renderRelations(relations) {
            const container = document.getElementById('relationsContainer');
            if (!relations.length) {
                container.innerHTML = '<div class="text-sm text-slate-400">ê´€ê³„ ì—†ìŒ</div>';
                return;
            }
            container.innerHTML = relations.map((rel, idx) => `
                <div class="bg-slate-50 p-3 rounded border mb-2 space-y-2">
                    <div class="flex justify-between">
                        <span class="text-sm font-medium">${rel.name || 'ê´€ê³„'}</span>
                        <button onclick="removeRelation(${idx})" class="text-red-500 text-xs">ì‚­ì œ</button>
                    </div>
                    <input type="text" class="form-input text-sm rel-name" value="${rel.name || ''}" placeholder="ì´ë¦„">
                    <input type="text" class="form-input text-sm rel-initial" value="${rel.initial || ''}" placeholder="ì´ë‹ˆì…œ">
                    <textarea class="form-input form-textarea text-sm rel-detail" rows="2" placeholder="ì„¤ëª…">${rel.detail || ''}</textarea>
                </div>
            `).join('');
        }

        function addRelation() {
            const p = characterData.profiles[currentKey];
            if (!p.relationships) p.relationships = [];
            p.relationships.push({ name: '', initial: '', detail: '' });
            renderRelations(p.relationships);
        }

        function removeRelation(idx) {
            characterData.profiles[currentKey].relationships.splice(idx, 1);
            renderRelations(characterData.profiles[currentKey].relationships);
        }

        function saveProfile() {
            const p = characterData.profiles[currentKey];
            const profileFields = configData.fieldDefinitions.profile || {};
            
            p.tabLabel = document.getElementById('profile_tabLabel').value;
            p.themeColor = document.getElementById('profile_themeColor').value;
            p.name = {
                kr: document.getElementById('profile_name_kr').value,
                en: document.getElementById('profile_name_en').value
            };
            p.image = document.getElementById('profile_image').value;
            p.imageCredit = {
                text: document.getElementById('profile_imageCredit_text').value,
                url: document.getElementById('profile_imageCredit_url').value
            };
            p.affiliation = {
                type: document.getElementById('profile_affiliation_type').value,
                name: document.getElementById('profile_affiliation_name').value
            };
            p.proposition = {
                number: document.getElementById('profile_proposition_number').value,
                kanji: document.getElementById('profile_proposition_kanji').value,
                description: document.getElementById('profile_proposition_description').value
            };
            p.quote = {
                main: document.getElementById('profile_quote_main').value,
                sub: document.getElementById('profile_quote_sub').value || null,
                description: document.getElementById('profile_quote_description').value.split('\n')
            };
            p.personality = {
                tags: document.getElementById('profile_personality_tags').value.split(',').map(t => t.trim()).filter(t => t),
                description: document.getElementById('profile_personality_description').value.split('\n')
            };
            
            // Config ê¸°ë°˜ basic
            p.basic = {};
            (profileFields.basic || []).forEach(field => {
                const el = document.getElementById(`profile_basic_${field.key}`);
                if (el) p.basic[field.key] = el.value;
            });
            
            // Config ê¸°ë°˜ magic
            p.magic = {};
            (profileFields.magic || []).forEach(field => {
                if (field.type === 'song') {
                    p.magic[field.key] = {
                        title: document.getElementById(`profile_magic_${field.key}_title`)?.value || '',
                        artist: document.getElementById(`profile_magic_${field.key}_artist`)?.value || '',
                        url: document.getElementById(`profile_magic_${field.key}_url`)?.value || ''
                    };
                } else {
                    const el = document.getElementById(`profile_magic_${field.key}`);
                    if (el) p.magic[field.key] = el.value;
                }
            });
            
            p.bgMusic = {
                youtubeId: document.getElementById('profile_bgMusic_youtubeId').value,
                title: document.getElementById('profile_bgMusic_title').value
            };
            
            // ê´€ê³„ ì €ì¥
            const relEls = document.getElementById('relationsContainer').querySelectorAll('.bg-slate-50');
            p.relationships = Array.from(relEls).map(el => ({
                name: el.querySelector('.rel-name').value,
                initial: el.querySelector('.rel-initial').value,
                detail: el.querySelector('.rel-detail').value
            }));
            
            renderSections();
            HelperUtils.showToast('ì €ì¥ë¨', 'success');
        }

        // ==========================================
        // í•„ë“œ ë Œë”ë§ í—¬í¼
        // ==========================================
        function renderField(field, data, prefix) {
            const id = `${prefix}_${field.key}`;
            
            if (field.type === 'group') {
                const groupData = data[field.key] || {};
                return `
                    <div class="border-t pt-4 mt-4">
                        <h3 class="font-bold text-sm text-slate-600 mb-3">${field.label}</h3>
                        <div class="grid grid-cols-2 gap-4">
                            ${field.fields.map(f => `
                                <div>
                                    <label class="form-label">${f.label}</label>
                                    <input type="text" id="${id}_${f.key}" class="form-input" value="${groupData[f.key] || ''}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (field.type === 'color') {
                const colorData = data[field.key] || { name: '', hex: '' };
                return `
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="form-label">${field.label} ì´ë¦„</label>
                            <input type="text" id="${id}_name" class="form-input" value="${colorData.name || ''}">
                        </div>
                        <div>
                            <label class="form-label">${field.label} HEX</label>
                            <div class="flex gap-2">
                                <input type="color" id="${id}_picker" class="w-10 h-10 rounded" value="${colorData.hex || '#000000'}" 
                                    onchange="document.getElementById('${id}_hex').value=this.value">
                                <input type="text" id="${id}_hex" class="form-input flex-1" value="${colorData.hex || ''}">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ê¸°ë³¸ text
            return `
                <div class="mt-4">
                    <label class="form-label">${field.label}</label>
                    <input type="text" id="${id}" class="form-input" value="${data[field.key] || ''}">
                </div>
            `;
        }

        // ==========================================
        // í”„ë¡œí•„ ì¶”ê°€/ì‚­ì œ
        // ==========================================
        function showAddProfile() {
            hideAllForms();
            currentSection = 'add';
            document.getElementById('addProfileForm').classList.remove('hidden');
            renderSections();
        }

        function createProfile() {
            const key = document.getElementById('newProfileKey').value.trim();
            if (!key) return alert('í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            if (characterData.profiles[key]) return alert('ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
            
            const profileFields = configData.fieldDefinitions.profile || {};
            
            // Config ê¸°ë°˜ìœ¼ë¡œ ë¹ˆ í”„ë¡œí•„ ìƒì„±
            const basic = {};
            (profileFields.basic || []).forEach(f => basic[f.key] = '');
            
            const magic = {};
            (profileFields.magic || []).forEach(f => {
                if (f.type === 'song') magic[f.key] = { title: '', artist: '', url: '' };
                else magic[f.key] = '';
            });
            
            characterData.profiles[key] = {
                tabLabel: key,
                themeColor: '#888888',
                name: { kr: '', en: '' },
                image: '',
                imageCredit: { text: '', url: '' },
                affiliation: { type: 'house', name: '' },
                proposition: { number: '', kanji: '', description: '' },
                quote: { main: '', sub: null, description: [] },
                personality: { tags: [], description: [] },
                basic,
                magic,
                relationships: [],
                bgMusic: { youtubeId: '', title: '' }
            };
            
            document.getElementById('newProfileKey').value = '';
            showProfile(key);
            HelperUtils.showToast('í”„ë¡œí•„ ìƒì„±ë¨', 'success');
        }

        function deleteProfile() {
            if (!confirm(`"${currentKey}" ì‚­ì œ?`)) return;
            delete characterData.profiles[currentKey];
            hideAllForms();
            currentSection = null;
            currentKey = null;
            renderSections();
        }

        // ==========================================
        // ë‚´ë³´ë‚´ê¸°
        // ==========================================
        function exportData() {
            if (currentSection === 'common') saveCommon();
            if (currentSection === 'profile') saveProfile();
            
            const code = HelperUtils.generateCharacterCode(characterData);
            document.getElementById('exportArea').classList.remove('hidden');
            document.getElementById('exportResult').value = code;
            document.getElementById('exportArea').scrollIntoView({ behavior: 'smooth' });
        }

        function copyCode() {
            HelperUtils.copyToClipboard(document.getElementById('exportResult').value);
            HelperUtils.showToast('ë³µì‚¬ë¨!', 'success');
        }
    </script>
</body>
</html>
