<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºë¦­í„° í¸ì§‘ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="utils.js"></script>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-100">

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bg-white border-b px-6 py-3 flex justify-between items-center z-10 shrink-0 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-slate-500 hover:text-indigo-600">
                <i data-lucide="arrow-left"></i>
            </a>
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="user-cog" class="text-purple-600"></i>
                ìºë¦­í„° í¸ì§‘ê¸°
            </h1>
        </div>
        <button onclick="exportData()" class="btn btn-success">
            <i data-lucide="save" class="w-4 h-4"></i> ì½”ë“œ ìƒì„±
        </button>
    </nav>

    <!-- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° -->
    <div class="bg-white border-b p-4 shrink-0">
        <label class="form-label">ğŸ“‚ character.js ì½”ë“œ ë¶™ì—¬ë„£ê¸°</label>
        <div class="flex gap-2 relative">
            <textarea id="inputCode" rows="1" class="form-input flex-1 h-10 resize-none" 
                placeholder="export const characterData = {...} í˜•ì‹ì˜ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
            <button onclick="loadData()" class="btn btn-secondary">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="startNew()" class="btn btn-primary">ìƒˆë¡œ ì‹œì‘</button>
            <div id="inputBlocker" class="absolute inset-0 bg-gray-100/80 hidden flex items-center justify-center text-xs font-bold text-gray-500 cursor-not-allowed">
                ì´ë¯¸ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div class="flex-1 overflow-hidden grid grid-cols-12">
        <!-- ì¢Œì¸¡: ì„¹ì…˜ ë©”ë‰´ -->
        <div class="col-span-3 bg-white border-r flex flex-col overflow-hidden">
            <div class="p-3 bg-slate-50 border-b">
                <span class="font-bold text-sm text-slate-700">ì„¹ì…˜ ì„ íƒ</span>
            </div>
            <div id="sectionList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-slate-50">
                <div class="text-center text-gray-400 text-xs mt-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”</div>
            </div>
        </div>

        <!-- ìš°ì¸¡: í¸ì§‘ ì˜ì—­ -->
        <div class="col-span-9 bg-slate-50 overflow-y-auto p-6" id="rightPanel">
            <!-- ê³µí†µ ì •ë³´ í¸ì§‘ -->
            <div id="commonForm" class="hidden max-w-3xl mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h2 class="font-bold text-slate-700">ğŸŒ ê³µí†µ ì •ë³´ (common)</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ìƒì¼</label>
                                <input type="text" id="common_birthday" class="form-input" placeholder="11ì›” 29ì¼">
                            </div>
                            <div>
                                <label class="form-label">íƒ„ìƒí™”</label>
                                <input type="text" id="common_birthFlower" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">íƒ„ìƒëª©</label>
                                <input type="text" id="common_birthTree" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">íƒ„ìƒì„</label>
                                <input type="text" id="common_birthStone" class="form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">íƒ„ìƒìƒ‰ ì´ë¦„</label>
                                <input type="text" id="common_birthColorName" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">íƒ„ìƒìƒ‰ HEX</label>
                                <div class="flex gap-2">
                                    <input type="color" id="common_birthColorPicker" class="w-10 h-10 rounded cursor-pointer">
                                    <input type="text" id="common_birthColorHex" class="form-input flex-1" placeholder="#8B0000">
                                </div>
                            </div>
                        </div>
                        <div class="border-t pt-4 mt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸª„ ì§€íŒ¡ì´ ì •ë³´</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">ëª©ì¬</label>
                                    <input type="text" id="common_wandWood" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">ì‹¬</label>
                                    <input type="text" id="common_wandCore" class="form-input">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label class="form-label">ê¸¸ì´</label>
                                    <input type="text" id="common_wandLength" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">ìœ ì—°ì„±</label>
                                    <input type="text" id="common_wandFlexibility" class="form-input">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 border-t pt-4">
                            <div>
                                <label class="form-label">í˜ˆí†µ</label>
                                <input type="text" id="common_bloodStatus" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">ëª¨ì—í™”</label>
                                <input type="text" id="common_moehua" class="form-input">
                            </div>
                        </div>
                        <div class="pt-4 border-t flex justify-end">
                            <button onclick="saveCommon()" class="btn btn-primary">
                                <i data-lucide="check" class="w-4 h-4"></i> ì ìš©
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í”„ë¡œí•„ í¸ì§‘ -->
            <div id="profileForm" class="hidden max-w-3xl mx-auto">
                <div class="card">
                    <div class="card-header flex justify-between items-center">
                        <h2 class="font-bold text-slate-700">ğŸ‘¤ í”„ë¡œí•„: <span id="profileKey">-</span></h2>
                        <button onclick="deleteProfile()" class="btn btn-danger text-xs">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> ì‚­ì œ
                        </button>
                    </div>
                    <div class="card-body space-y-4">
                        <!-- íƒ­ ë¼ë²¨ & í…Œë§ˆ -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">íƒ­ ë¼ë²¨ (í‘œì‹œëª…)</label>
                                <input type="text" id="profile_tabLabel" class="form-input" placeholder="1í•™ë…„ (11ì„¸) ë˜ëŠ” ìºë¦­í„°A">
                            </div>
                            <div>
                                <label class="form-label">í…Œë§ˆ ìƒ‰ìƒ</label>
                                <div class="flex gap-2">
                                    <input type="color" id="profile_themeColorPicker" class="w-10 h-10 rounded cursor-pointer">
                                    <input type="text" id="profile_themeColor" class="form-input flex-1" placeholder="#FFD800">
                                </div>
                            </div>
                        </div>

                        <!-- ì´ë¦„ -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ì´ë¦„ (í•œê¸€)</label>
                                <input type="text" id="profile_nameKr" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">ì´ë¦„ (ì˜ë¬¸)</label>
                                <input type="text" id="profile_nameEn" class="form-input">
                            </div>
                        </div>

                        <!-- ì´ë¯¸ì§€ -->
                        <div>
                            <label class="form-label">ì´ë¯¸ì§€ URL</label>
                            <input type="text" id="profile_image" class="form-input" placeholder="https://...">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ì´ë¯¸ì§€ í¬ë ˆë”§</label>
                                <input type="text" id="profile_imageCreditText" class="form-input" placeholder="@ì‘ê°€ëª…">
                            </div>
                            <div>
                                <label class="form-label">í¬ë ˆë”§ URL</label>
                                <input type="text" id="profile_imageCreditUrl" class="form-input">
                            </div>
                        </div>

                        <!-- ì†Œì† -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">ì†Œì† íƒ€ì…</label>
                                <select id="profile_affiliationType" class="form-input">
                                    <option value="house">ê¸°ìˆ™ì‚¬ (house)</option>
                                    <option value="order">ê¸°ì‚¬ë‹¨ (order)</option>
                                    <option value="faction">ì§„ì˜ (faction)</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">ì†Œì† ì´ë¦„</label>
                                <input type="text" id="profile_affiliationName" class="form-input" placeholder="HUFFLEPUFF">
                            </div>
                        </div>

                        <!-- ëª…ì œ -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ“œ ëª…ì œ</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">ë²ˆí˜¸</label>
                                    <input type="text" id="profile_propNumber" class="form-input" placeholder="ì œ 1 ëª…ì œ">
                                </div>
                                <div>
                                    <label class="form-label">í•œì</label>
                                    <input type="text" id="profile_propKanji" class="form-input" placeholder="å®š">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">ì„¤ëª… (HTML íƒœê·¸ ê°€ëŠ¥)</label>
                                <input type="text" id="profile_propDesc" class="form-input" placeholder="ëª¨ë“  <em>ë¯¸ë˜</em>ëŠ” ë¶ˆë³€í•œë‹¤.">
                            </div>
                        </div>

                        <!-- í•œë§ˆë”” -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ’¬ í•œë§ˆë””</h3>
                            <div>
                                <label class="form-label">ë©”ì¸ (HTML íƒœê·¸ ê°€ëŠ¥)</label>
                                <input type="text" id="profile_quoteMain" class="form-input">
                            </div>
                            <div class="mt-3">
                                <label class="form-label">ì„œë¸Œ</label>
                                <input type="text" id="profile_quoteSub" class="form-input">
                            </div>
                            <div class="mt-3">
                                <label class="form-label">ì„¤ëª… (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
                                <textarea id="profile_quoteDesc" rows="3" class="form-input form-textarea"></textarea>
                            </div>
                        </div>

                        <!-- ì„±ê²© -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ­ ì„±ê²©</h3>
                            <div>
                                <label class="form-label">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                                <input type="text" id="profile_personalityTags" class="form-input" placeholder="#ë¬´ì‹ ê²½, #ë¬´ë°˜ì‘, #ë¬´ê°ê°">
                            </div>
                            <div class="mt-3">
                                <label class="form-label">ì„¤ëª… (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
                                <textarea id="profile_personalityDesc" rows="4" class="form-input form-textarea"></textarea>
                            </div>
                        </div>

                        <!-- ê¸°ë³¸ ìŠ¤íƒ¯ -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ“Š ê¸°ë³¸ ìŠ¤íƒ¯</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="form-label">ë‚˜ì´</label>
                                    <input type="text" id="profile_basicAge" class="form-input" placeholder="11ì„¸ (1í•™ë…„)">
                                </div>
                                <div>
                                    <label class="form-label">í‚¤</label>
                                    <input type="text" id="profile_basicHeight" class="form-input" placeholder="130cm">
                                </div>
                                <div>
                                    <label class="form-label">ì²´ì¤‘</label>
                                    <input type="text" id="profile_basicWeight" class="form-input" placeholder="25kg">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label class="form-label">ê¸°ìˆ™ì‚¬/ì§„ì˜</label>
                                    <input type="text" id="profile_basicHouse" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">êµ­ì </label>
                                    <input type="text" id="profile_basicNationality" class="form-input">
                                </div>
                            </div>
                        </div>

                        <!-- ë¬´ë“œê³¡ -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸµ ë¬´ë“œê³¡</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">ì œëª©</label>
                                    <input type="text" id="profile_moodSongTitle" class="form-input">
                                </div>
                                <div>
                                    <label class="form-label">ì•„í‹°ìŠ¤íŠ¸</label>
                                    <input type="text" id="profile_moodSongArtist" class="form-input">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">URL</label>
                                <input type="text" id="profile_moodSongUrl" class="form-input">
                            </div>
                        </div>

                        <!-- ë°°ê²½ìŒì•… -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3">ğŸ”Š ë°°ê²½ ìŒì•…</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">YouTube ID</label>
                                    <input type="text" id="profile_bgMusicId" class="form-input" placeholder="dQw4w9WgXcQ">
                                </div>
                                <div>
                                    <label class="form-label">ì œëª©</label>
                                    <input type="text" id="profile_bgMusicTitle" class="form-input">
                                </div>
                            </div>
                        </div>

                        <!-- ê´€ê³„ -->
                        <div class="border-t pt-4">
                            <h3 class="font-bold text-sm text-slate-600 mb-3 flex justify-between items-center">
                                <span>ğŸ‘¥ ê´€ê³„</span>
                                <button onclick="addRelation()" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded">+ ì¶”ê°€</button>
                            </h3>
                            <div id="relationsContainer" class="space-y-3"></div>
                        </div>

                        <div class="pt-4 border-t flex justify-end">
                            <button onclick="saveProfile()" class="btn btn-primary">
                                <i data-lucide="check" class="w-4 h-4"></i> ì ìš©
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìƒˆ í”„ë¡œí•„ ì¶”ê°€ -->
            <div id="addProfileForm" class="hidden max-w-md mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h2 class="font-bold text-slate-700">â• ìƒˆ í”„ë¡œí•„ ì¶”ê°€</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div>
                            <label class="form-label">í”„ë¡œí•„ í‚¤ (ë‚˜ì´, ìºë¦­í„°ëª… ë“± ììœ ë¡­ê²Œ)</label>
                            <input type="text" id="newProfileKey" class="form-input" placeholder="11, characterA, ëª¨ë¦¬ìŠ¨ ë“±">
                        </div>
                        <button onclick="createProfile()" class="btn btn-primary w-full">ìƒì„±</button>
                    </div>
                </div>
            </div>

            <!-- ì½”ë“œ ì¶œë ¥ -->
            <div id="exportArea" class="hidden mt-6 code-output max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-green-400 font-bold">âœ… ì½”ë“œ ìƒì„± ì™„ë£Œ</span>
                    <button onclick="copyCode()" class="btn btn-success text-sm">ğŸ“‹ ë³µì‚¬</button>
                </div>
                <textarea id="exportResult" rows="20" class="w-full" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let data = null;
        let currentSection = null;
        let currentKey = null;

        function startNew() {
            data = {
                common: {
                    birthday: "",
                    birthFlower: "",
                    birthTree: "",
                    birthStone: "",
                    birthColor: { name: "", hex: "#000000" },
                    wand: { wood: "", core: "", length: "", flexibility: "" },
                    bloodStatus: "",
                    moehua: ""
                },
                profiles: {}
            };
            renderSections();
            document.getElementById('inputBlocker').classList.remove('hidden');
            document.getElementById('inputCode').disabled = true;
            HelperUtils.showToast('ìƒˆ ìºë¦­í„° ë°ì´í„° ì‹œì‘! í”„ë¡œí•„ì„ ì¶”ê°€í•˜ì„¸ìš”.', 'success');
        }

        function loadData() {
            const raw = document.getElementById('inputCode').value.trim();
            if (!raw) return alert('ì½”ë“œë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.');
            
            try {
                data = HelperUtils.parseExportData(raw, 'characterData');
                renderSections();
                document.getElementById('inputBlocker').classList.remove('hidden');
                document.getElementById('inputCode').disabled = true;
                HelperUtils.showToast('ë°ì´í„° ë¡œë“œ ì™„ë£Œ!', 'success');
            } catch (e) {
                alert('ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        function renderSections() {
            const list = document.getElementById('sectionList');
            const keys = Object.keys(data.profiles || {});
            
            list.innerHTML = `
                <div class="list-item ${currentSection === 'common' ? 'active' : ''}" onclick="showCommon()">
                    <span class="font-medium text-sm">ğŸŒ ê³µí†µ ì •ë³´</span>
                </div>
                <div class="text-xs text-slate-500 mt-3 mb-1 px-2">í”„ë¡œí•„ ëª©ë¡</div>
                ${keys.map(key => `
                    <div class="list-item ${currentSection === 'profile' && currentKey === key ? 'active' : ''}" onclick="showProfile('${key}')">
                        <span class="font-medium text-sm">${data.profiles[key].tabLabel || key}</span>
                    </div>
                `).join('')}
                <div class="list-item mt-2" onclick="showAddProfile()">
                    <span class="text-indigo-600 font-medium text-sm">+ ìƒˆ í”„ë¡œí•„ ì¶”ê°€</span>
                </div>
            `;
        }

        function hideAllForms() {
            document.getElementById('commonForm').classList.add('hidden');
            document.getElementById('profileForm').classList.add('hidden');
            document.getElementById('addProfileForm').classList.add('hidden');
            document.getElementById('exportArea').classList.add('hidden');
        }

        function showCommon() {
            hideAllForms();
            currentSection = 'common';
            currentKey = null;
            
            const c = data.common;
            document.getElementById('common_birthday').value = c.birthday || '';
            document.getElementById('common_birthFlower').value = c.birthFlower || '';
            document.getElementById('common_birthTree').value = c.birthTree || '';
            document.getElementById('common_birthStone').value = c.birthStone || '';
            document.getElementById('common_birthColorName').value = c.birthColor?.name || '';
            document.getElementById('common_birthColorHex').value = c.birthColor?.hex || '';
            document.getElementById('common_birthColorPicker').value = c.birthColor?.hex || '#000000';
            document.getElementById('common_wandWood').value = c.wand?.wood || '';
            document.getElementById('common_wandCore').value = c.wand?.core || '';
            document.getElementById('common_wandLength').value = c.wand?.length || '';
            document.getElementById('common_wandFlexibility').value = c.wand?.flexibility || '';
            document.getElementById('common_bloodStatus').value = c.bloodStatus || '';
            document.getElementById('common_moehua').value = c.moehua || '';
            
            document.getElementById('commonForm').classList.remove('hidden');
            renderSections();
        }

        function saveCommon() {
            data.common = {
                birthday: document.getElementById('common_birthday').value,
                birthFlower: document.getElementById('common_birthFlower').value,
                birthTree: document.getElementById('common_birthTree').value,
                birthStone: document.getElementById('common_birthStone').value,
                birthColor: {
                    name: document.getElementById('common_birthColorName').value,
                    hex: document.getElementById('common_birthColorHex').value
                },
                wand: {
                    wood: document.getElementById('common_wandWood').value,
                    core: document.getElementById('common_wandCore').value,
                    length: document.getElementById('common_wandLength').value,
                    flexibility: document.getElementById('common_wandFlexibility').value
                },
                bloodStatus: document.getElementById('common_bloodStatus').value,
                moehua: document.getElementById('common_moehua').value
            };
            HelperUtils.showToast('ì €ì¥ë¨', 'success');
        }

        function showProfile(key) {
            hideAllForms();
            currentSection = 'profile';
            currentKey = key;
            
            const p = data.profiles[key];
            document.getElementById('profileKey').textContent = p.tabLabel || key;
            
            document.getElementById('profile_tabLabel').value = p.tabLabel || '';
            document.getElementById('profile_themeColor').value = p.themeColor || '';
            document.getElementById('profile_themeColorPicker').value = p.themeColor || '#000000';
            document.getElementById('profile_nameKr').value = p.name?.kr || '';
            document.getElementById('profile_nameEn').value = p.name?.en || '';
            document.getElementById('profile_image').value = p.image || '';
            document.getElementById('profile_imageCreditText').value = p.imageCredit?.text || '';
            document.getElementById('profile_imageCreditUrl').value = p.imageCredit?.url || '';
            document.getElementById('profile_affiliationType').value = p.affiliation?.type || 'house';
            document.getElementById('profile_affiliationName').value = p.affiliation?.name || '';
            document.getElementById('profile_propNumber').value = p.proposition?.number || '';
            document.getElementById('profile_propKanji').value = p.proposition?.kanji || '';
            document.getElementById('profile_propDesc').value = p.proposition?.description || '';
            document.getElementById('profile_quoteMain').value = p.quote?.main || '';
            document.getElementById('profile_quoteSub').value = p.quote?.sub || '';
            document.getElementById('profile_quoteDesc').value = (p.quote?.description || []).join('\n');
            document.getElementById('profile_personalityTags').value = (p.personality?.tags || []).join(', ');
            document.getElementById('profile_personalityDesc').value = (p.personality?.description || []).join('\n');
            document.getElementById('profile_basicAge').value = p.basic?.age || '';
            document.getElementById('profile_basicHeight').value = p.basic?.height || '';
            document.getElementById('profile_basicWeight').value = p.basic?.weight || '';
            document.getElementById('profile_basicHouse').value = p.basic?.house || p.basic?.faction || '';
            document.getElementById('profile_basicNationality').value = p.basic?.nationality || '';
            document.getElementById('profile_moodSongTitle').value = p.magic?.moodSong?.title || '';
            document.getElementById('profile_moodSongArtist').value = p.magic?.moodSong?.artist || '';
            document.getElementById('profile_moodSongUrl').value = p.magic?.moodSong?.url || '';
            document.getElementById('profile_bgMusicId').value = p.bgMusic?.youtubeId || '';
            document.getElementById('profile_bgMusicTitle').value = p.bgMusic?.title || '';
            
            renderRelations(p.relationships || []);
            
            document.getElementById('profileForm').classList.remove('hidden');
            renderSections();
        }

        function renderRelations(relations) {
            const container = document.getElementById('relationsContainer');
            if (relations.length === 0) {
                container.innerHTML = '<div class="text-sm text-slate-400">ë“±ë¡ëœ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            container.innerHTML = relations.map((rel, idx) => `
                <div class="bg-slate-50 p-3 rounded border space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">${rel.name}</span>
                        <button onclick="removeRelation(${idx})" class="text-red-500 text-xs">ì‚­ì œ</button>
                    </div>
                    <input type="text" class="form-input text-sm rel-name" value="${rel.name || ''}" placeholder="ì´ë¦„">
                    <input type="text" class="form-input text-sm rel-initial" value="${rel.initial || ''}" placeholder="ì´ë‹ˆì…œ">
                    <textarea class="form-input form-textarea text-sm rel-detail" rows="2" placeholder="ì„¤ëª…">${rel.detail || ''}</textarea>
                </div>
            `).join('');
        }

        function addRelation() {
            const p = data.profiles[currentKey];
            if (!p.relationships) p.relationships = [];
            p.relationships.push({ name: 'ìƒˆ ê´€ê³„', initial: '', detail: '' });
            renderRelations(p.relationships);
        }

        function removeRelation(idx) {
            const p = data.profiles[currentKey];
            p.relationships.splice(idx, 1);
            renderRelations(p.relationships);
        }

        function saveProfile() {
            const p = data.profiles[currentKey];
            
            p.tabLabel = document.getElementById('profile_tabLabel').value;
            p.themeColor = document.getElementById('profile_themeColor').value;
            p.name = {
                kr: document.getElementById('profile_nameKr').value,
                en: document.getElementById('profile_nameEn').value
            };
            p.image = document.getElementById('profile_image').value;
            p.imageCredit = {
                text: document.getElementById('profile_imageCreditText').value,
                url: document.getElementById('profile_imageCreditUrl').value
            };
            p.affiliation = {
                type: document.getElementById('profile_affiliationType').value,
                name: document.getElementById('profile_affiliationName').value
            };
            p.proposition = {
                number: document.getElementById('profile_propNumber').value,
                kanji: document.getElementById('profile_propKanji').value,
                description: document.getElementById('profile_propDesc').value
            };
            p.quote = {
                main: document.getElementById('profile_quoteMain').value,
                sub: document.getElementById('profile_quoteSub').value || null,
                description: document.getElementById('profile_quoteDesc').value.split('\n').filter(l => l.trim() !== '' || l === '')
            };
            p.personality = {
                tags: document.getElementById('profile_personalityTags').value.split(',').map(t => t.trim()).filter(t => t),
                description: document.getElementById('profile_personalityDesc').value.split('\n')
            };
            p.basic = {
                age: document.getElementById('profile_basicAge').value,
                height: document.getElementById('profile_basicHeight').value,
                weight: document.getElementById('profile_basicWeight').value,
                house: document.getElementById('profile_basicHouse').value,
                nationality: document.getElementById('profile_basicNationality').value
            };
            p.magic = {
                moodSong: {
                    title: document.getElementById('profile_moodSongTitle').value,
                    artist: document.getElementById('profile_moodSongArtist').value,
                    url: document.getElementById('profile_moodSongUrl').value
                }
            };
            p.bgMusic = {
                youtubeId: document.getElementById('profile_bgMusicId').value,
                title: document.getElementById('profile_bgMusicTitle').value
            };
            
            // ê´€ê³„ ì €ì¥
            const relEls = document.getElementById('relationsContainer').querySelectorAll('.bg-slate-50');
            p.relationships = Array.from(relEls).map(el => ({
                name: el.querySelector('.rel-name').value,
                initial: el.querySelector('.rel-initial').value,
                detail: el.querySelector('.rel-detail').value
            }));
            
            renderSections();
            HelperUtils.showToast('ì €ì¥ë¨', 'success');
        }

        function showAddProfile() {
            hideAllForms();
            currentSection = 'add';
            document.getElementById('addProfileForm').classList.remove('hidden');
            renderSections();
        }

        function createProfile() {
            const key = document.getElementById('newProfileKey').value.trim();
            if (!key) return alert('í”„ë¡œí•„ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            if (data.profiles[key]) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‚¤ì…ë‹ˆë‹¤.');
            
            data.profiles[key] = {
                tabLabel: key,
                themeColor: '#888888',
                name: { kr: '', en: '' },
                image: '',
                imageCredit: { text: '', url: '' },
                affiliation: { type: 'house', name: '' },
                proposition: { number: '', kanji: '', description: '' },
                quote: { main: '', sub: null, description: [] },
                personality: { tags: [], description: [] },
                basic: { age: '', height: '', weight: '', house: '', nationality: '' },
                magic: { moodSong: { title: '', artist: '', url: '' } },
                relationships: [],
                bgMusic: { youtubeId: '', title: '' }
            };
            
            document.getElementById('newProfileKey').value = '';
            showProfile(key);
            HelperUtils.showToast('í”„ë¡œí•„ ìƒì„±ë¨', 'success');
        }

        function deleteProfile() {
            if (!confirm(`"${currentKey}" í”„ë¡œí•„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            delete data.profiles[currentKey];
            hideAllForms();
            currentSection = null;
            currentKey = null;
            renderSections();
        }

        function exportData() {
            if (currentSection === 'common') saveCommon();
            if (currentSection === 'profile') saveProfile();
            
            const code = HelperUtils.generateCharacterCode(data);
            document.getElementById('exportArea').classList.remove('hidden');
            document.getElementById('exportResult').value = code;
            document.getElementById('exportArea').scrollIntoView({ behavior: 'smooth' });
        }

        function copyCode() {
            HelperUtils.copyToClipboard(document.getElementById('exportResult').value);
            HelperUtils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        // ìƒ‰ìƒ í”¼ì»¤ ë™ê¸°í™”
        document.getElementById('common_birthColorPicker').addEventListener('input', e => {
            document.getElementById('common_birthColorHex').value = e.target.value;
        });
        document.getElementById('profile_themeColorPicker').addEventListener('input', e => {
            document.getElementById('profile_themeColor').value = e.target.value;
        });
    </script>
</body>
</html>
